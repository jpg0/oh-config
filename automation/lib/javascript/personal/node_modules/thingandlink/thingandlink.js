const provider = require('ohj').provider;
const log = require('ohj').log("thingandlink");

let addToSystem = function(thingsAndItems){
    log.debug("Adding tais to system...");

    let itemsProvider = provider.newCallbackItemProvider();
    let thingsProvider = provider.newCallbackThingProvider();
    let metadataProvider = provider.newCallbackMetadataProvider();
    
    for(let tai of thingsAndItems) {
        tai.addToMetadataProvider(metadataProvider);
        tai.addToThingsProvider(thingsProvider);
        tai.addToItemsProvider(itemsProvider); //items last as they will wire up bindings
    }

    log.debug("Registering providers...");

    metadataProvider.register();  
    thingsProvider.register();     
    itemsProvider.register();

    log.debug("Registered providers");

    for(let tai of thingsAndItems) {
        tai.activateRules();
    }

    log.debug("Activated rules");

    return {
        itemsProvider,
        thingsProvider,
        metadataProvider
    }
}

module.exports = {
    addToSystem,
    device: {
        ...require('./tasmotatai'),
        ...require('./zigbeebulbtai'),
        ...require('./xiaomizigbeetai'),
        ...require('./neorollertai'),
        ...require('./tuyarollertai'),
        ...require('./433tai'),
        ...require('./zigbeebuttontai'),
        ...require('./huezigbeetai'),
        ...require('./commontai'),
        // ...require('./dahuacam'),
    }
}