let EventEmitter = require('vendor/events');
let HttpClient = Java.type('org.eclipse.jetty.client.HttpClient');
let DigestAuthentication = Java.type('org.eclipse.jetty.client.util.DigestAuthentication');
let URI = Java.type('java.net.URI');

let logger = require('ohj').log('request');

/*
This is a very simple implementation of https://github.com/request/request using Jetty Client
*/

class Request extends EventEmitter {
    constructor(config, cb) {
        super();

        this.uri = config.uri;

        this.auth = config.auth;
        this.headers = config.headers;
        this.cb = cb;
        //setTimeout(this.doRequest.bind(this), 1);
        this.doRequest();
    }

    doRequest() {

        let httpClient = new HttpClient();

        let returnError = e => {
            if(this.cb) {
                this.cb(e);
            } else {
                this.emit('error', e);
            }
        }

        try
        {
            httpClient.start();

            if(this.auth) {
                httpClient.getAuthenticationStore().addAuthentication(
                    new DigestAuthentication(new URI(this.uri), "<<ANY_REALM>>", this.auth.user.toString(), this.auth.password.toString()));
            }

            let response = httpClient.newRequest(this.uri).send()
            let status = response.getStatus();

            if(status >= 200 && status < 400) {
                if(this.cb) {
                    this.cb(undefined, {
                        statusCode: response.getStatus()
                    }, response.getContentAsString().toString());
                } else {
                    this.emit('data', response.getContent());
                    this.emit('end');
                }
            } else {
                let err = new Error(`${status}: ${response.getContentAsString()}`)
                returnError(err);
            }
        } catch(e) {
            returnError(e);
        } finally {
            httpClient.stop();
        }
    }
}

module.exports = (config, cb) => new Request(config, cb)



  
    //   client.on('response', () => {
    //     debug(`Connected to ${this.baseUri}`);
    //     this.emit("connect")
    //   });
    //   client.on('error', err => this.emit("error", err));
    //   client.on('data', this.handleDahuaEventData.bind(this));
    //   client.on('close', () => {   // Try to reconnect after 30s
    //     () => setTimeout(() => this.listenForEvents(eventNames), 30000);
    //     this.emit("end");
    //   });